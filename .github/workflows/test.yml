name: Test Remote Upload Action

on:
  push:
    branches:
      - remote-upload
    paths-ignore:
      - '**.md'
  pull_request:
    branches:
      - remote-upload
    paths-ignore:
      - '**.md'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create test files
        run: |
          # Create test files
          mkdir -p test-files
          echo "Test file 1" > test-files/file1.txt
          echo "Test file 2" > test-files/file2.txt
          mkdir -p test-files/nested
          echo "Nested test file" > test-files/nested/file3.txt
          
          # Create a larger test file
          dd if=/dev/urandom of=test-files/large-file.bin bs=1M count=5
          
          # Create a file with timestamp
          echo "Deployment timestamp: $(date)" > test-files/timestamp.txt
      
      - name: Upload to shared host
        id: upload
        uses: ./
        with: 
          host: ${{ secrets.SHARED_HOST }}
          username: ${{ secrets.SHARED_HOST_USER }}
          private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ./test-files/
          destination: ${{ secrets.SHARED_HOST_PATH }}/test-upload/
          rsync: true
          options: "--exclude=*.bak --delete"
          strict-host-key-checking: "false"
          post-commands: "ls -la ${{ secrets.SHARED_HOST_PATH }}/test-upload/; echo 'Test completed at $(date)' > ${{ secrets.SHARED_HOST_PATH }}/test-upload/completed.txt"
      
      - name: Display upload results
        run: |
          echo "Upload status: ${{ steps.upload.outputs.status }}"
          echo "Files transferred: ${{ steps.upload.outputs.transferred-files }}"
          echo "Bytes transferred: ${{ steps.upload.outputs.transferred-bytes }}"
